# 親タスク作成(T01) 詳細設計書

## 1. 概要
- 機能名：親タスク作成(T01)
- 概要：ToDoアプリケーションの新しい親タスクの作成を行う。認証されたユーザがタスクタイトルと詳細を入力し、parent_tasksテーブルに登録する。

## 2. シーケンス
```mermaid
sequenceDiagram
    participant UI as フロントエンド
    participant API as バックエンドAPI
    participant DB as MySQL

    UI->>API: 1 POST /api/tasks（JWTトークン、タスク情報）
    API->>API: 2 認証チェック
    API->>API: 3 入力バリデーション
    API->>DB: 4 親タスク情報をparent_tasksテーブルに登録
    DB-->>API: 5 登録結果
    API-->>UI: 6 レスポンス（作成されたタスク情報/エラー）
```

1. フロントエンドから認証トークンと新規親タスク情報を受け取る
2. JWTトークンの認証チェックとユーザID取得
3. タスクタイトルと詳細の入力値をバリデーション
4. 親タスク情報をデータベースに登録
5. データベースから登録結果を受け取る
6. フロントエンドに処理結果を返却

## 3. フロー図
```mermaid
graph TD;
    Start((開始)) --> TokenCheck[1 認証トークン検証];
    TokenCheck --> TokenResult{2 認証結果};
    TokenResult -- 失敗 --> Fail(異常終了);
    TokenResult -- 成功 --> Validation[3 入力バリデーション];
    Validation --> ValResult{4 バリデーション結果};
    ValResult -- 失敗 --> Fail;
    ValResult -- 成功 --> DBInsert[5 親タスク登録];
    DBInsert --> DBResult{6 登録結果};
    DBResult -- 失敗 --> Fail;
    DBResult -- 成功 --> Success(正常終了);
```

### 具体的な処理
1. **認証トークン検証**
    - リクエストヘッダーからAuthorizationヘッダーを取得
    - Bearer形式のJWTトークンの存在確認と署名検証
    - トークンの有効期限チェック
    - ペイロードからuser_idを取得
    - エラー時の処理
        - トークンが存在しない場合はログメッセージ（E-T0001）を出力し、HTTPステータス401で処理を終了
        - トークンが無効な場合はログメッセージ（E-T0002）を出力し、HTTPステータス401で処理を終了

2. **認証結果**
    - JWTトークンの検証結果を判定

3. **入力バリデーション**
    - タイトル(title)
        - 文字列であること
        - 1文字以上255文字以内であること
        - エラー時の処理
            - バリデーション失敗時はログメッセージ（E-T0003）を出力し、HTTPステータス400で処理を終了
    - 詳細(description)
        - 文字列であること（空文字列も許可）
        - 65535文字以内であること（TEXT型の制限）
        - エラー時の処理
            - バリデーション失敗時はログメッセージ（E-T0004）を出力し、HTTPステータス400で処理を終了

4. **バリデーション結果**
    - 入力値のバリデーション結果を判定

5. **親タスク登録**
    - 対象テーブル名：parent_tasks
    - 登録するフィールド
        - user_id：認証トークンから取得したユーザID
        - title：入力されたタスクタイトル
        - description：入力されたタスク詳細（空文字列の場合はNULL）
        - status：'pending'（デフォルト値）
        - created_at：現在日時（自動設定）
        - updated_at：現在日時（自動設定）
    - エラー時の処理
        - DB接続が不可の時はログメッセージ（E-T0005）を出力し、HTTPステータス500で処理を終了
        - DB登録が失敗した場合はログメッセージ（E-T0006）を出力し、HTTPステータス500で処理を終了

6. **登録結果**
    - データベース登録結果を判定
    - 成功時はログメッセージ（I-T0001）を出力し、HTTPステータス201で作成されたタスク情報（parent_task_id, title, description, status, created_at）を返却
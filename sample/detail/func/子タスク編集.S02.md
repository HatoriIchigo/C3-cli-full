# 子タスク編集(S02) 詳細設計書

## 1. 概要
- 機能名：子タスク編集(S02)
- 概要：ToDoアプリケーションで既存の子タスクの編集を行う。認証されたユーザが親タスクの所有者であることを確認後、指定された子タスクのタイトルと詳細をchild_tasksテーブルで更新する。

## 2. シーケンス
```mermaid
sequenceDiagram
    participant UI as フロントエンド
    participant API as バックエンドAPI
    participant DB as MySQL

    UI->>API: 1 PUT /api/children/:id（JWTトークン、更新子タスク情報）
    API->>API: 2 認証チェック
    API->>DB: 3 子タスク存在確認・親タスク所有者確認
    DB-->>API: 4 子タスク・親タスク情報
    API->>API: 5 入力バリデーション
    API->>DB: 6 子タスク情報をchild_tasksテーブルで更新
    DB-->>API: 7 更新結果
    API-->>UI: 8 レスポンス（更新された子タスク情報/エラー）
```

1. フロントエンドから認証トークンと更新する子タスク情報を受け取る
2. JWTトークンの認証チェックとユーザID取得
3. 指定された子タスクの存在確認と親タスクの所有者確認
4. データベースから子タスク・親タスク情報を受け取る
5. 更新する子タスクのタイトルと詳細の入力値をバリデーション
6. 子タスク情報をデータベースで更新
7. データベースから更新結果を受け取る
8. フロントエンドに処理結果を返却

## 3. フロー図
```mermaid
graph TD;
    Start((開始)) --> TokenCheck[1 認証トークン検証];
    TokenCheck --> TokenResult{2 認証結果};
    TokenResult -- 失敗 --> Fail(異常終了);
    TokenResult -- 成功 --> ChildCheck[3 子タスク存在・親タスク所有者確認];
    ChildCheck --> ChildResult{4 確認結果};
    ChildResult -- 失敗 --> Fail;
    ChildResult -- 成功 --> Validation[5 入力バリデーション];
    Validation --> ValResult{6 バリデーション結果};
    ValResult -- 失敗 --> Fail;
    ValResult -- 成功 --> DBUpdate[7 子タスク更新];
    DBUpdate --> DBResult{8 更新結果};
    DBResult -- 失敗 --> Fail;
    DBResult -- 成功 --> Success(正常終了);
```

### 具体的な処理
1. **認証トークン検証**
    - リクエストヘッダーからAuthorizationヘッダーを取得
    - Bearer形式のJWTトークンの存在確認と署名検証
    - トークンの有効期限チェック
    - ペイロードからuser_idを取得
    - エラー時の処理
        - トークンが存在しない場合はログメッセージ（E-S0009）を出力し、HTTPステータス401で処理を終了
        - トークンが無効な場合はログメッセージ（E-S0010）を出力し、HTTPステータス401で処理を終了

2. **認証結果**
    - JWTトークンの検証結果を判定

3. **子タスク存在・親タスク所有者確認**
    - 対象テーブル名：child_tasks JOIN parent_tasks
    - 取得条件：child_tasks.child_task_id = 'URLパラメータの子タスクID' AND parent_tasks.user_id = '認証ユーザID'
    - 取得フィールド：child_tasks.child_task_id, child_tasks.title, child_tasks.description, child_tasks.status, parent_tasks.parent_task_id
    - JOIN条件：child_tasks.parent_task_id = parent_tasks.parent_task_id
    - エラー時の処理
        - DB接続が不可の時はログメッセージ（E-S0011）を出力し、HTTPステータス500で処理を終了
        - 該当子タスクが存在しない、または親タスクの所有者が異なる場合はログメッセージ（E-S0012）を出力し、HTTPステータス404で処理を終了

4. **確認結果**
    - 子タスクの存在と親タスク所有者の確認結果を判定

5. **入力バリデーション**
    - タイトル(title)
        - 文字列であること
        - 1文字以上255文字以内であること
        - エラー時の処理
            - バリデーション失敗時はログメッセージ（E-S0013）を出力し、HTTPステータス400で処理を終了
    - 詳細(description)
        - 文字列であること（空文字列も許可）
        - 65535文字以内であること（TEXT型の制限）
        - エラー時の処理
            - バリデーション失敗時はログメッセージ（E-S0014）を出力し、HTTPステータス400で処理を終了

6. **バリデーション結果**
    - 入力値のバリデーション結果を判定

7. **子タスク更新**
    - 対象テーブル名：child_tasks
    - 更新条件：child_task_id = 'URLパラメータの子タスクID'
    - 更新するフィールド
        - title：入力された子タスクタイトル
        - description：入力された子タスク詳細（空文字列の場合はNULL）
        - updated_at：現在日時（自動設定）
    - エラー時の処理
        - DB接続が不可の時はログメッセージ（E-S0015）を出力し、HTTPステータス500で処理を終了
        - DB更新が失敗した場合はログメッセージ（E-S0016）を出力し、HTTPステータス500で処理を終了

8. **更新結果**
    - データベース更新結果を判定
    - 成功時はログメッセージ（I-S0002）を出力し、HTTPステータス200で更新された子タスク情報（child_task_id, parent_task_id, title, description, status, updated_at）を返却
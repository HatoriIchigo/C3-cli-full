# ネットワーク詳細設計書

## 概要
ToDoアプリケーションのネットワーク構成とセキュリティ設計について詳細に定義します。

## ネットワーク構成

### VPC設定
- **VPC CIDR**: 10.0.0.0/16
- **リージョン**: ap-northeast-1（東京リージョン）
- **アベイラビリティーゾーン**: 1つのAZ（コスト重視）

### サブネット設定
- **パブリックサブネット**: 10.0.1.0/24
  - インターネットゲートウェイ経由でインターネットアクセス可能
  - フロントエンドEC2、バックエンドEC2、RDSを配置

### IPアドレス割り当て
- **フロントエンドEC2**: 10.0.1.10
- **バックエンドEC2**: 10.0.1.11
- **RDS MySQL**: 10.0.1.12（自動割り当て）

## 通信許可一覧

| 送信元 | 送信先 | ポート番号 | セキュリティグループ | 備考 |
| -- | -- | -- | -- | -- |
| インターネット | 10.0.1.10 (フロントエンド用EC2) | 443(HTTPS) | frontend-sg | フロントエンドWebアプリへのHTTPS通信 |
| インターネット | 10.0.1.10 (フロントエンド用EC2) | 80(HTTP) | frontend-sg | HTTPからHTTPSへのリダイレクト用 |
| SSH接続元IP | 10.0.1.10 (フロントエンド用EC2) | 22(SSH) | frontend-sg | 管理者によるSSH接続（特定IPのみ） |
| SSH接続元IP | 10.0.1.11 (バックエンド用EC2) | 22(SSH) | backend-sg | 管理者によるSSH接続（特定IPのみ） |
| 10.0.1.10 (フロントエンド用EC2) | 10.0.1.11 (バックエンド用EC2) | 3000(API) | backend-sg | フロントエンドからAPIサーバへの通信 |
| 10.0.1.11 (バックエンド用EC2) | RDS MySQL | 3306(MySQL) | rds-sg | バックエンドからデータベースへの通信 |
| 10.0.1.10 (フロントエンド用EC2) | インターネット | ALL | - | GitHub Actionsデプロイ、パッケージダウンロード用 |
| 10.0.1.11 (バックエンド用EC2) | インターネット | ALL | - | GitHub Actionsデプロイ、パッケージダウンロード用 |

## セキュリティグループ詳細

### frontend-sg（フロントエンド用）
**インバウンドルール**
- HTTP (80): インターネットから許可（0.0.0.0/0）
- HTTPS (443): インターネットから許可（0.0.0.0/0）
- SSH (22): 管理者IPアドレスのみ許可

**アウトバウンドルール**
- ALL: 全て許可（デプロイ・更新のため）

### backend-sg（バックエンド用）
**インバウンドルール**
- Custom TCP (3000): フロントエンドEC2からのみ許可（10.0.1.10/32）
- SSH (22): 管理者IPアドレスのみ許可

**アウトバウンドルール**
- ALL: 全て許可（デプロイ・更新のため）

### rds-sg（RDS用）
**インバウンドルール**
- MySQL (3306): バックエンドEC2からのみ許可（10.0.1.11/32）

**アウトバウンドルール**
- 不要（RDSは受信のみ）

## ルーティング設定

### パブリックサブネット用ルートテーブル
- **0.0.0.0/0** → インターネットゲートウェイ
- **10.0.0.0/16** → Local

## セキュリティ考慮事項

### アクセス制御
- SSH接続は管理者の固定IPアドレスからのみ許可
- データベースはバックエンドサーバからのみアクセス可能
- フロントエンドとバックエンド間は内部通信で分離

### 通信暗号化
- インターネットからの通信はHTTPS必須
- 内部通信は平文だが、VPC内で分離されているため安全

### 監視・ログ
- VPC Flow Logsを有効化（コスト考慮で必要最小限）
- CloudWatch Logsでアプリケーションレベルの監視

## チェック結果

### 本当にアクセスが許可されているか
- [x] **インターネット → フロントエンドEC2 (HTTPS/HTTP)**: ✅ ユーザがWebアプリにアクセスするため必要
- [x] **SSH接続元IP → 各EC2 (SSH)**: ✅ 管理者が運用・保守のためアクセス、特定IP制限でセキュリティ確保
- [x] **フロントエンドEC2 → バックエンドEC2 (API)**: ✅ フロントエンドがAPIを呼び出すため必要
- [x] **バックエンドEC2 → RDS (MySQL)**: ✅ APIがデータベースにアクセスするため必要
- [x] **各EC2 → インターネット (ALL)**: ✅ デプロイ、パッケージダウンロード、OS更新のため必要

**チェック結果: すべての通信許可に適切な理由があり、過剰な権限はありません ✅**
# ToDoアプリケーション 基本設計書

## はじめに

### 本書の目的
本書は、AWS基盤上で稼働するToDoアプリケーションの基本設計書です。階層構造を持つタスク管理機能とユーザ認証機能を提供するWebベースのアプリケーションシステムの基本設計について記載します。

本システムは、個人のタスク管理効率向上を目的とし、React（フロントエンド）、Node.js + Express（バックエンド）、MySQL（データベース）を用いた3層アーキテクチャで構成されます。コストパフォーマンスを最優先とした個人開発規模の設計とします。

### 基本設計書の記載範囲
- システム全体構成とアーキテクチャ
- OS設定とミドルウェア構成
- アプリケーション基本設計
- 画面設計の概要
- 非機能要件に基づく設計方針

## 全体構成

### システム構成
本システムは以下の構成要素から成り立ちます：

#### 実装するアプリ
- **フロントエンドアプリケーション**
  - React 18.x + Material-UI による Web UI
  - EC2インスタンス上でNginxによる静的ファイル配信
  - ユーザ認証、タスク管理画面の提供

- **バックエンドアプリケーション**
  - Node.js + Express による RESTful API サーバ
  - EC2インスタンス上でPM2によるプロセス管理
  - JWT認証、タスクCRUD操作、ビジネスロジック実装

- **データベース**
  - Amazon RDS for MySQL 8.0
  - ユーザ情報、タスクデータの永続化

#### 外部連携システムなど
- **AWS クラウドサービス**
  - EC2: アプリケーション実行環境（フロントエンド・バックエンド各1台）
  - RDS: マネージド MySQL データベース
  - VPC: ネットワーク分離とセキュリティ制御
  - Security Groups: ファイアウォール機能
  - Route53: DNS管理（ドメイン取得時）
  - Certificate Manager: SSL証明書管理（HTTPS化時）

- **ユーザとの関係性**
  - エンドユーザ ↔ Webブラウザ ↔ フロントエンドアプリ ↔ バックエンドAPI ↔ データベース

## OS設定

### OSの種類
- **フロントエンドサーバ**: Amazon Linux 2 (EC2インスタンス)
- **バックエンドサーバ**: Amazon Linux 2 (EC2インスタンス)
- **データベース**: Amazon RDS for MySQL 8.0 (マネージドサービス)

### バージョン
- Amazon Linux 2 LTS (最新AMI)
- MySQL 8.0 (RDS最新マイナーバージョン)

### タイムゾーン
- 日本標準時 (JST, Asia/Tokyo)
- アプリケーションログと管理の統一性を確保

### パッケージ
#### 基本パッケージ
- `curl`, `wget`: ファイルダウンロード用
- `git`: ソースコード管理
- `cron`: 定期実行タスク（ログローテーション、バックアップ等）
- `logrotate`: ログファイルローテーション
- `htop`: システムリソース監視

#### アプリケーション固有パッケージ
- **フロントエンドサーバ**:
  - `nginx`: Webサーバ・リバースプロキシ
  - `certbot`: SSL証明書取得・更新
- **バックエンドサーバ**:
  - `nodejs`: Node.js 18.x LTS
  - `npm`: パッケージマネージャ
  - `pm2`: プロセス管理 (グローバルインストール)

### 時刻同期
- NTPサーバ: Amazon Time Sync Service (169.254.169.123)
- 自動同期設定により時刻の正確性を保証

### 名前解決
- **DNS**: AWS提供のDNSサーバを使用
- **hosts**: 必要に応じてローカル名前解決を追加
- Route53でのドメイン管理（将来対応）

### ユーザ管理
#### ユーザ区分とグループ
- **システム管理者**: `ec2-user` (デフォルトユーザ、sudo権限あり)
- **アプリケーション実行**: `ec2-user` (個人開発のため同一ユーザ)
- **サービスグループ**: `nginx`, `node` (各サービス用)

#### セキュリティ設定
- rootログイン: 禁止
- SSH鍵認証: 必須
- パスワード認証: 無効化

### ログ
#### ログ収集システム
- **rsyslog**: システムログ管理
- **アプリケーションログ**: 各アプリケーション個別管理
  - フロントエンド: nginxアクセスログ・エラーログ
  - バックエンド: winston によるアプリケーションログ

#### ローテーション設定
- **システムログ**: 週次ローテーション、4週保持
- **アプリケーションログ**: 日次ローテーション、30日保持
- **nginx ログ**: 日次ローテーション、30日保持

### ディスク構成
#### ファイルシステムとパーティション
- **ルートパーティション** (`/`): 20GB, ext4, OS・システムファイル用
- **アプリケーション領域** (`/opt/app`): 10GB, ext4, アプリケーション配置用
- **ログ領域** (`/var/log`): 5GB, ext4, ログファイル保存用
- **一時領域** (`/tmp`): 2GB, ext4, 一時ファイル用

#### 使用目的
- `/opt/app/frontend`: フロントエンドアプリケーション
- `/opt/app/backend`: バックエンドアプリケーション
- `/var/log/nginx`: Nginxログ
- `/var/log/app`: アプリケーションログ

## アプリケーション概要

### 共通設計

#### 言語・フレームワーク
- **フロントエンド**: JavaScript (ES2022+) + React 18.x
- **バックエンド**: JavaScript (Node.js 18.x LTS) + Express 4.x
- **データベース**: MySQL 8.0
- **スタイリング**: Material-UI (MUI) v5 + CSS-in-JS

#### コーディング規約
- **ファイル命名**: kebab-case
- **変数・関数**: camelCase
- **定数**: UPPER_SNAKE_CASE
- **コンポーネント**: PascalCase
- **インデント**: スペース2個、UTF-8、LF改行

#### アプリ異常時のふるまい
- **API通信エラー**: 最大3回まで自動リトライ、指数バックオフ (1秒、2秒、4秒)
- **データベース接続エラー**: 最大5回リトライ、10秒間隔
- **認証エラー**: 即座にログイン画面にリダイレクト
- **予期しないエラー**: エラー境界でキャッチし、ユーザにフレンドリーなメッセージを表示

#### ログ設計
- **フロントエンド**: 
  - 開発環境: console.error使用
  - 本番環境: 重要なエラーのみサーバに送信
- **バックエンド**: 
  - winston使用による構造化ログ (JSON形式)
  - ログレベル: ERROR, WARN, INFO, DEBUG
  - ローテーション: 日次、30日保持

#### アプリケーション設定ファイル
- **フロントエンド**: 環境変数 (.env) - API Base URL等
- **バックエンド**: 環境変数 (.env) - DB接続情報、JWT Secret等
- **パスワード暗号化**: bcrypt使用、salt rounds = 12

### アプリケーション個別設計

#### フロントエンドアプリケーション設計

**アプリケーションの概要**
React SPAによるレスポンシブなWeb UIを提供し、ユーザフレンドリーなタスク管理インターフェースを実現する。

**大機能(Major Feature)ごとの処理概要**

- **ユーザ管理 (U)**
  - ユーザ名、パスワードを引数として受け取り、バックエンドAPIでJWT認証を実行
  - 認証成功時はトークンをlocalStorageに保存し、メイン画面に遷移
  - 認証失敗時は最大3回までリトライ可能、エラーメッセージを表示
  - ログアウト時はトークンを削除し、ログイン画面にリダイレクト

- **タスク管理 (T)**
  - 親タスクリストを取得し、Material-UIのCardコンポーネントで一覧表示
  - 各親タスクをクリックすると、子タスクリストをアコーディオン形式で展開
  - タスク作成・編集はモーダルダイアログでフォーム表示、React Hook Formでバリデーション
  - 子タスクの完了状態変更はチェックボックスでワンクリック操作
  - リアルタイム更新のため、操作後即座にAPIコールし画面を再描画

#### バックエンドアプリケーション設計

**アプリケーションの概要**
Express.jsによるRESTful APIサーバとして、認証・認可機能とタスクデータのCRUD操作を提供する。

**大機能(Major Feature)ごとの処理概要**

- **ユーザ管理API (U)**
  - POST /api/auth/register: ユーザ登録時にbcryptでパスワードハッシュ化、MySQL usersテーブルに保存
  - POST /api/auth/login: ユーザ名・パスワード照合後、JWTトークン発行 (有効期限24時間)
  - ミドルウェアでJWTトークン検証、無効時は401 Unauthorizedレスポンス
  - レート制限: ログイン試行は5分間に10回まで

- **タスク管理API (T)**
  - GET /api/tasks: ユーザIDでフィルタした親タスク一覧と関連子タスクをJOINで取得
  - POST /api/tasks: リクエストボディのバリデーション後、parent_tasksテーブルに新規作成
  - PUT /api/tasks/:id: 既存タスクの更新、楽観的ロック(updated_at)で整合性保証
  - POST /api/tasks/:parentId/children: 子タスク作成、parent_task_idで親子関係を設定
  - PATCH /api/tasks/children/:id/complete: 子タスクの完了状態をboolean値で更新

## 画面設計

### 画面構成概要
本アプリケーションは以下の主要画面で構成されるシングルページアプリケーション（SPA）です：

1. **ログイン画面** - ユーザ認証
2. **ユーザ登録画面** - 新規アカウント作成  
3. **メイン画面** - タスク管理のメイン機能
4. **エラー画面** - システムエラー表示

### 各画面の設計詳細

#### 1. ログイン画面 (Login)
**画面内容**
- アプリケーションタイトル
- ユーザ名入力フィールド（テキストボックス）
- パスワード入力フィールド（パスワードボックス）
- ログインボタン
- 新規登録リンク
- エラーメッセージ表示エリア

**レイアウト**
- 中央寄せのカード形式
- Material-UI Paper コンポーネント使用
- レスポンシブ対応（モバイル・デスクトップ）

#### 2. ユーザ登録画面 (Register)
**画面内容**
- 画面タイトル「新規登録」
- ユーザ名入力フィールド（バリデーション付き）
- パスワード入力フィールド（強度チェック付き）
- パスワード確認入力フィールド
- 登録ボタン
- ログイン画面戻りリンク
- バリデーションエラー表示エリア

#### 3. メイン画面 (Dashboard)
**ヘッダー部分**
- アプリケーションロゴ・タイトル
- ログイン中ユーザ名表示
- ログアウトボタン
- 新規親タスク作成ボタン

**メインコンテンツ部分**
- **親タスクリスト表示エリア**
  - 各親タスクをCard形式で縦並び表示
  - 親タスク名、作成日、子タスク完了状況（例：3/5完了）
  - 編集・削除ボタン
  - 展開/折りたたみアイコン

- **子タスクリスト表示エリア**（各親タスク内）
  - アコーディオン形式で親タスク下に展開
  - チェックボックス + 子タスク名のリスト形式
  - 完了済みタスクは打ち消し線
  - 新規子タスク追加ボタン
  - 各子タスクの編集・削除ボタン

**モーダルダイアログ**
- **親タスク作成・編集ダイアログ**
  - タスク名入力フィールド
  - 説明入力フィールド（任意）
  - 保存・キャンセルボタン

- **子タスク作成・編集ダイアログ**
  - タスク名入力フィールド
  - 保存・キャンセルボタン

#### 4. エラー画面 (Error)
**画面内容**
- エラーアイコン
- エラーメッセージ
- ホームに戻るボタン

### 画面遷移パターン

```
[ログイン画面] 
    ↓ 認証成功
[メイン画面] 
    ↓ ログアウト
[ログイン画面]

[ログイン画面] 
    ↓ 新規登録リンク
[ユーザ登録画面] 
    ↓ 登録成功/ログインリンク
[ログイン画面]

[全画面共通] 
    ↓ システムエラー発生
[エラー画面]
```

### レスポンシブ対応
- **デスクトップ** (1200px以上): 3カラムレイアウト
- **タブレット** (768px-1199px): 2カラムレイアウト  
- **モバイル** (767px以下): 1カラムレイアウト、ハンバーガーメニュー

### アクセシビリティ考慮
- キーボードナビゲーション対応
- スクリーンリーダー対応（aria-label設定）
- 適切なコントラスト比の確保
- フォーカス状態の視覚的表示

## 非機能設計

### 監視設計

#### 方針
- **監視ツール**: AWS CloudWatch + 基本的なシステムコマンド使用
- **監視対象**: システムリソース、アプリケーション稼働状況、データベース接続
- **アラート**: 重要な障害時のみ、メール通知（個人開発レベル）

#### 監視項目
- **システムリソース監視**
  - CPU使用率（80%超過時アラート）
  - メモリ使用率（85%超過時アラート）  
  - ディスク容量（90%超過時アラート）
- **アプリケーション監視**
  - プロセス生存確認（pm2 status）
  - HTTP応答確認（curl health check）
  - エラーログ監視（重要エラーの検知）
- **データベース監視**
  - RDS接続確認
  - スロークエリログ確認

#### 各種パッケージに必要な設定事項
- **CloudWatch Agent**: EC2メトリクス送信設定
- **rsyslog**: ログ集約とローテーション設定
- **cron**: 定期健康チェックスクリプト実行（5分間隔）

### セキュリティ設計

#### アクセス制御
- **SSH接続**: 鍵認証のみ許可、パスワード認証禁止
  - 理由: 総当たり攻撃からの保護と認証強度向上
- **Root直接ログイン**: 完全禁止
  - 理由: 権限昇格の透明性確保と操作ログ追跡可能性
- **sudo権限**: ec2-userのみ、パスワード入力必須
  - 理由: 誤操作防止と操作責任の明確化

#### ネットワークセキュリティ
- **Security Groups設定**:
  - SSH (22): 管理用IPアドレスからのみ許可
  - HTTP (80) / HTTPS (443): 全世界からアクセス許可
  - MySQL (3306): バックエンドサーバからのみ許可
  - 理由: 最小権限の原則に基づくアクセス制御

#### アプリケーションセキュリティ
- **パスワード管理**: bcrypt によるハッシュ化（salt rounds = 12）
  - 理由: レインボーテーブル攻撃耐性と十分な計算量確保
- **SQL インジェクション対策**: Sequelize ORM使用、プリペアドステートメント
  - 理由: SQLクエリの安全な実行と入力値サニタイズ
- **XSS対策**: React標準のエスケープ機能 + DOMPurify（必要時）
  - 理由: スクリプト注入攻撃からの保護
- **CSRF対策**: SameSite Cookie設定 + Origin検証
  - 理由: 意図しないリクエスト送信の防止

#### HTTPS通信
- **SSL/TLS**: Let's Encrypt証明書使用
  - 理由: 通信内容の暗号化と認証、無料での証明書取得
- **HSTS**: HTTP Strict Transport Security有効化
  - 理由: 中間者攻撃防止とHTTPS強制

### その他

#### 運用設計
- **サーバ起動・停止**: 手動実行、コスト最適化優先
- **デプロイ**: Git pull + アプリケーション再起動による手動デプロイ
- **バックアップ**: RDS自動バックアップ（7日保持）+ 手動スナップショット
- **ログ管理**: 30日間保持、必要時のみ詳細確認

#### 可用性設計
- **稼働時間**: 平日日中メイン、必要時のみ24時間稼働
- **復旧手順**: 標準的な再起動手順書の整備
- **障害対応**: 単一ユーザのため、迅速性よりコスト優先

#### 性能設計
- **目標値**:
  - ページ読み込み時間: 5秒以内
  - API応答時間: 3秒以内
  - データベースクエリ: 2秒以内
- **最適化手法**:
  - 適切なDBインデックス設計
  - 静的ファイルのgzip圧縮
  - 必要に応じたクエリ最適化
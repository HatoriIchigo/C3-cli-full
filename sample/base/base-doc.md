# 基本設計書

## はじめに

### 本書の目的
本書は、ToDoアプリケーション開発プロジェクトにおける基本設計書です。要件定義書で定義された機能要件・非機能要件を基に、システム全体のアーキテクチャ、技術構成、基本的な設計方針を明確に定義します。

### システムの概要
個人のタスク処理を円滑にするための階層型ToDoアプリケーション。ユーザ認証機能を持ち、親タスクと子タスクの階層構造によるタスク管理機能を提供するWebアプリケーションです。AWSクラウドインフラ上で動作し、React（フロントエンド）、Node.js + Express（バックエンド）、MySQL（データベース）の構成で実装します。

### 基本設計書の記載範囲
- システム全体構成とアーキテクチャ
- OS設定と環境構築要件
- アプリケーション共通設計方針
- 大機能ごとの処理概要
- 画面設計の基本方針
- 非機能設計（監視、セキュリティ、運用など）

詳細な実装方法、具体的なコード設計、データベーステーブル定義は詳細設計書で定義します。

## 全体構成

### システム構成

#### 実装するアプリ
- **フロントエンドアプリケーション（React）**
  - ユーザインターフェース提供
  - ブラウザ上で動作するSPAアプリケーション
  - バックエンドAPIとHTTP通信

- **バックエンドAPIアプリケーション（Node.js + Express）**
  - RESTful API提供
  - ビジネスロジック実装
  - データベースとの接続・データ処理

- **データベース（RDS MySQL）**
  - ユーザ情報・認証情報の永続化
  - タスクデータの永続化
  - 階層構造データの管理

#### 外部連携システム
- なし（アプリケーション機能として外部APIとの連携は行わない）

#### システム関係図
```
[ユーザ（ブラウザ）]
      ↓ HTTPS
[フロントエンドサーバ（EC2）]
      ↓ HTTP API
[バックエンドサーバ（EC2）]
      ↓ MySQL
[データベース（RDS）]
```

#### ユーザとの関係性
- **主要ユーザ**: 個人（タスク管理を行う利用者）
- **アクセス方法**: WebブラウザからHTTPS接続
- **認証方式**: ユーザ名・パスワード認証
- **利用デバイス**: PC・スマートフォン対応

## OS設定

### OSの種類とバージョン
- **フロントエンドサーバ**: Amazon Linux 2023
- **バックエンドサーバ**: Amazon Linux 2023
- **理由**: AWS最適化、長期サポート、セキュリティ更新の自動適用

### タイムゾーン設定
- **設定値**: JST (Asia/Tokyo)
- **理由**: 日本のユーザ向けアプリケーションのため

### 必要パッケージ
#### 共通パッケージ
- **chrony**: NTP時刻同期
- **git**: ソースコード管理
- **wget/curl**: ファイルダウンロード

#### フロントエンドサーバ
- **nginx**: リバースプロキシ・静的ファイル配信
- **Node.js v18+**: アプリケーション実行環境
- **npm**: パッケージ管理

#### バックエンドサーバ
- **Node.js v18+**: アプリケーション実行環境
- **PM2**: プロセス管理・監視
- **npm**: パッケージ管理

### 時刻同期設定
- **利用サービス**: chrony（Amazon Time Sync Service）
- **同期先**: 169.254.169.123（AWS内蔵NTPサーバ）
- **設定理由**: AWS環境内での正確な時刻同期、ログの整合性確保

### 名前解決設定
- **DNS**: AWS提供のDNSサーバを利用
- **設定**: デフォルト設定を使用（DHCPによる自動設定）
- **hostsファイル**: 必要に応じてローカルホスト名のみ設定

### ユーザ管理
- **システム管理者**: ec2-user（デフォルト）
- **アプリケーション実行ユーザ**: ec2-user
- **SSH接続**: 鍵認証のみ許可（パスワード認証無効）
- **sudo権限**: ec2-userに付与

### ログ設定
- **ログ収集**: rsyslog + CloudWatch Logs Agent
- **アプリケーションログ**: /var/log/todo-app/
- **システムログ**: /var/log/ (標準)
- **ローテーション**: logrotate（日次、30日保持）

### ディスク構成
#### フロントエンドサーバ
- **ルートボリューム**: 8GB (gp3)
  - OS領域: 4GB
  - アプリケーション領域: 2GB
  - ログ領域: 1GB
  - 予備領域: 1GB

#### バックエンドサーバ
- **ルートボリューム**: 8GB (gp3)
  - OS領域: 4GB
  - アプリケーション領域: 2GB
  - ログ領域: 1GB
  - 予備領域: 1GB

## アプリケーション概要

### 共通設計

#### 言語・フレームワーク
- **フロントエンド**: React 18+（JavaScript ES2020+）
- **バックエンド**: Node.js v18+、Express.js 4.x
- **データベース**: MySQL 8.0
- **コーディング規約**: ESLint（Airbnb準拠）+ Prettier

#### アプリ異常時のふるまい
- **API通信エラー**: 最大3回まで指数バックオフでリトライ
- **データベース接続エラー**: アプリケーション停止、ログ出力後手動復旧
- **認証エラー**: ログイン画面へリダイレクト
- **バリデーションエラー**: エラーメッセージ表示、ユーザ入力継続可能

#### ログ設計
- **ログ形式**: JSON形式
- **ログレベル**: ERROR, WARN, INFO, DEBUG
- **出力先**: CloudWatch Logs
- **機密情報**: パスワード等の出力禁止

#### アプリケーション設定ファイル
- **形式**: .env形式（環境変数）
- **暗号化**: 機密情報（DB接続情報、JWT秘密鍵）は環境変数で管理
- **設定項目**: ポート番号、DB接続情報、JWT設定、ログレベル

### アプリケーション個別設計

#### アプリケーションの概要
個人のタスク処理効率化を目的とした階層型ToDoアプリケーション。ユーザ認証により個人データを保護し、親タスク・子タスクの階層構造により複雑なタスク管理を可能にする。

#### 大機能ごとの処理概要

##### ユーザ管理(U)
- ユーザ名・パスワードを受け取り、bcryptでハッシュ化されたパスワードと照合
- 認証成功時はJWTトークン（1時間有効）を発行、Cookieにセット
- ログアウト時はトークン無効化、セッション情報削除
- 認証失敗時は3回まで許可、以降5分間アカウントロック

##### タスク管理(T)
- 親タスクの作成・編集時、ユーザIDと紐づけてデータベースに保存
- タスク一覧表示時は認証ユーザのタスクのみ取得・表示
- タスク編集時は所有者確認後、楽観的排他制御で更新
- タスク詳細表示時は親タスクと関連する子タスク一覧を同時取得

##### サブタスク管理(S)
- 子タスクは必ず親タスクIDと紐づけて作成
- 子タスク編集時は親タスクの所有者確認を実施
- 完了状態変更時はタイムスタンプを記録
- 親タスクの完了状態は子タスクの完了状況に連動

## 画面設計

### 画面構成
- **SPAアプリケーション**: シングルページアプリケーション
- **レスポンシブデザイン**: PC・スマートフォン対応
- **ブラウザ対応**: Chrome、Firefox、Safari、Edge（最新版）

### 主要画面とその内容

#### ログイン画面
- ユーザ名・パスワード入力フォーム
- ログインボタン
- ユーザ登録リンク

#### ユーザ登録画面
- ユーザ名・パスワード・確認パスワード入力フォーム
- 登録ボタン
- ログインページへのリンク

#### タスク一覧画面（メイン画面）
- ヘッダー（ユーザ名表示、ログアウトボタン）
- 親タスク一覧表示エリア
- 新規タスク作成ボタン
- 各タスクの完了状態表示・編集リンク

#### タスク詳細画面
- 親タスク詳細情報表示・編集フォーム
- 関連する子タスク一覧
- 子タスク新規作成フォーム
- 子タスク編集・完了状態変更機能

### 画面遷移パターン
```
ログイン画面 → タスク一覧画面（メイン）
    ↓           ↕
ユーザ登録画面   タスク詳細画面
```

## 非機能設計

### 監視設計

#### 監視方針
- **ツール**: CloudWatch（AWS標準監視サービス）
- **対象**: システムリソース、アプリケーションログ、エラー発生状況

#### 監視項目
- **システム監視**: CPU使用率、メモリ使用率、ディスク使用量
- **アプリケーション監視**: レスポンス時間、エラー発生率、API呼び出し回数
- **データベース監視**: 接続数、クエリ実行時間、デッドロック発生

#### アラート設定
- CPU使用率80%超過時
- メモリ使用率90%超過時
- アプリケーションエラー率5%超過時

### セキュリティ設計

#### 認証・認可
- **パスワードハッシュ化**: bcrypt（salt rounds: 12）
- **セッション管理**: JWT（1時間有効期限）
- **HTTPS通信**: 全通信の暗号化

#### 攻撃対策
- **SQLインジェクション対策**: パラメータ化クエリ必須
  - 理由: 悪意のあるSQL文の実行を防止、データベースの機密性・完全性を保護
- **XSS対策**: 入力値サニタイズ、CSPヘッダー設定
  - 理由: 悪意のあるスクリプト実行を防止、ユーザ情報の漏洩を防止
- **CSRF対策**: CSRFトークン実装
  - 理由: 意図しない操作の実行を防止、ユーザの意思に反する操作を阻止

#### アクセス制御
- **SSH接続**: 鍵認証のみ（パスワード認証無効）
  - 理由: ブルートフォース攻撃を防止、不正アクセスのリスク軽減
- **Rootログイン禁止**: 管理者権限の直接利用を制限
  - 理由: システム改ざんのリスク軽減、操作ログの追跡性向上

### 運用設計
- **デプロイ**: GitHub Actions による自動デプロイ
- **バックアップ**: RDS自動バックアップ（7日保持）
- **サーバ管理**: 手動起動・停止（コスト重視）

### 可用性設計
- **目標稼働率**: 95%（個人利用レベル）
- **障害復旧**: 24時間以内の手動復旧
- **データ保護**: データベース自動バックアップ